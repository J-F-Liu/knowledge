# RISC-V

RISC-V 指令集清晰且开源，与现有商用指令集相比，RISC-V 更加精简。此
外，RISC-V 支持在标准指令集之外，自定义扩展指令集，兼顾了灵活性。

RISC-V 基金会遵循的原则包括：

1. RISC-V 指令集及相关标准必须对所有人开放且无须授权；
2. RISC-V 指令集规范必须能够在线下载；
3. RISC-V 的兼容性测试套件必须提供源码下载。

为了保护 RISC-V 标准，只有基金会会员可以使用“RISC-V”及相关商标，并且只能用于已经通过 RISC-V 兼容性测试套件测试的产品。

RISC-V 最为重要的一个特点是模块化。处理器的设计者可以根据需求选择实现不
同的扩展，RV32I 是必选的基础扩展。

### RISC-V 主要的指令扩展如下：

- I 扩展：整数扩展（RV32I）为 RISC-V 的基础整数指令集，所有实现都必须支持。RV32I 极度精简，仅有 38 条指令，但是功能齐全，执行通用计算所必须的整数计算、访存、分支以及系统调用等指令一应俱全。处理器仅需支持 RV32I，便可以运行完整 RISC-V 软件栈。

- M 扩展：乘法扩展（RV32M）为 RISC-V 整数乘除法扩展指令集，M 扩展支持整数的有符号以及无符号乘除法运算。

- F 扩展/D 扩展：单精度浮点扩展（RV32F）和双精度浮点扩展
  （RV32D）为 RISC-V 的浮点指令集。共用一组独立于整数寄存器的浮
  点寄存器，拥有常规的访存和运算指令，也有一些包括乘加指令在内
  的融合运算指令，使得运算过程更精简而准确。另外为了有助于数学
  库的编写，还包括了有助于符号操作的符号注入指令和测试操作数属
  性的分类指令。F 和 D 扩展没有包括浮点分支指令，取而代之的是浮点
  比较指令，可以根据浮点数的比较结果设置寄存器的值，并用于条件
  分支。

- A 扩展：原子扩展（RV32A）为 RISC-V 的原子操作指令集，为同步操作
  提供了必要的支持。RV32A 扩展为不同的使用场景提供了两种对应的原
  子操作。其中加载保留（lr）指令和条件存储（sc）指令保证了原子
  的比较-交换（compare-and-swap）的实现；AMO 指令在多处理器系统
  中的可扩展性比 lr 和 sc 更好，可以实现 I/O 通信中的总线原子读
  写，从而简化设备驱动，提高 I/O 性能。

- G 扩展：通用扩展（RV32G）为 RISC-V 基础整数指令集 RV32I 加上标准扩展（M、F、D、A），统称 RV32G。

- C 扩展：压缩扩展（RV32C）为 RISC-V 的压缩指令集。包括了与标准 32 位 RISC-V 一一对应的短指令，它们只对汇编器和链接器可见，因此编译器编写者和汇编语言程序员可以忽略它们。以往的 ISA 设计在重新设计短指令集时，会为处理器和编译器的设计增加负担，而 RISC-V 通过上述设计避免了这一缺陷。

- V 扩展：向量扩展（RV32V）为 RISC-V 向量指令集，与其它指令集中的
  单指令多数据流（SIMD）指令不同的是，RV32V 将内部向量寄存器的宽
  度与指令集解耦，解决了 SIMD 指令集每一代升级宽度时，带来的上层
  软件适配问题。向量指令集支持向量计算、向量 load/store、向量条
  件运算等操作。

### RISC-V 的特权模式架构的特点：

与其它指令集一样，RISC-V 为操作系统和其它场景提供了更高的权限模
式。除了通常的用户模式（U 模式）以外，RISC-V 架构还包括最底层的机器模
式（M 模式）和为操作系统提供的监管者模式（S 模式）。M 模式是所有标准的
RISC-V 处理器必须实现的，拥有对硬件的完全控制权。简单的嵌入式系统只需
要支持 M 模式即可，在此模式下可以处理异常和中断。M 模式和 U 模式的组合
可以实现简单的基于地址寄存器比较的内存隔离，而更复杂的基于分页的虚拟
内存方案需要依靠 S 模式来实现。默认情况下，所有异常都会交由 M 模式处
理，但对于那些实现了 S 模式的系统，RISC-V 提供了一套异常委托机制，可以
选择性地将中断和同步异常交给 S 模式处理，完全绕过 M 模式，从而避免了异
常处理效率的降低。这两种权限模式各有一组控制状态寄存器（CSR），而嵌套
中断需要配合软件用栈实现。
