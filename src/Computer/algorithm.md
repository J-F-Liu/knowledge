# 共识算法

## 区块链

区块链是一种分布式记账系统。

在分布式系统中，最为关键的问题就是一致性问题。一致性问题指的是对于给定一组服务器节点指定一系列操作，在某个协议保障下，使得各服务器节点对处理结果达成一致，其中用到的协议也被称作为共识算法。正是因为共识机制的存在，区块链才可以在分布式网络中达到一致性状态。

在实际的分布式系统应用环境中，通过共识算法达到一致性，往往需要面对服务器节点保障及服务器节点之间的网络通信故障等问题。上述问题可以分为两类情况，一类情况是仅发生服务器宕机、通讯协议不可靠、消息延迟或丢失等情况。另外一种情况则更加严重，网络中不仅可能存在上述问题，还可能存在某些恶意节点，他们向其他节点发送虚假或者错误消息。针对此类情况，相关研究人员专门提出了拜占庭将军问题用于描述此类问题。

拜占庭将军问题是由 Leslie Lamport 在 1982 年提出的，具体描述如下：拜占庭帝国派出了 m 支军队去围攻一个敌人。由于拜占庭的军队在不同的地点，所以必须在分开的包围状态下同时攻击。他们任一支军队单独进攻都毫无胜算，除非有多于 n 支军队同时袭击才能攻下敌国，而军队之间只能依靠通信兵相互通信来协商进攻意向及进攻时间。但是在拜占庭将军之间可能存在叛徒，这些叛徒的目的是通过故意传出虚假消息或者不传出任何消息等行为，来阻挠其他忠诚的将军达成一致的作战计划。

## 已知的共识算法

不同的分布式系统，由于其故障类型不同，因此采用的共识算法也不同。根据处理的异常情况不同，同样可以分为两种类型，一种是针对非拜占庭错误的，这类算法性能较高，但容错性较差，如 Paxos、Raft 等，另一种是针对拜占庭错误的，这类算法往往容错性较高，但是性能相对较差，包括工作量证明（POW）、权益证明（POS）、股份授权证明（DPOS）、实用拜占庭容错算法（PBFT）等。处理拜占庭错误的算法有两种思路，一种是通过提高作恶节点的成本以降低作恶节点出现的概率，如工作量证明、权益证明等，其中工作量证明是通过算力，而权益证明则是通过持有权益。另外一种是在允许一定的作恶节点出现的前提下，依然使得各节点之间达成一致性，如实用拜占庭容错算法等。

### 工作量证明（Proof of Work，POW）

工作量证明是通过解决是一个不容易解答但是容易验证的问题来争取记账权以达到共识目的。例如，在比特币区块链中，是通过枚举法对得到的新字符串进行 SHA256 哈希运算，找出满足给定数量前导为 0 的哈希过程。前导 0 的个数越多，代表问题的难度越大。一旦某个节点找到符合要求的随机数，该节点就获得当前区块的记账权，并获得一定的奖励。

工作量证明算法实现简单，节点间无需交换额外的信息，但是能源消费比较高且共识达成的周期较长。

### 权益证明（Proof of Stake，POS）

权益证明是让网络中拥有越多权益的节点有机会做更多的决定，这种机制的假设前提是权益持有人更倾向于维护网络利益且担心作恶后遭受惩罚。权益证明的实现方式很多，比较典型的是引入 “币龄” 概念的方式，即用币龄来计算权益。每个代币持有一天记为一个币天，完成一次记账后清空一定的币天。例如，在交易中，某人收到 10 个币，持有 10 天，则拥有 100 币天，如果花去 5 个币，则消耗掉 50 币天。

权益证明算法不需要消耗大量资源，并在一定程度上缩短了确认时间，不过仍然需要挖矿。

### 股份授权证明（Delegated Proof of Stake，DPOS）

股份授权证明是基于权益证明发展而来的。股份授权证明能够让每个节点首先通过权益选举出 n 个记账节点，类似于公司中的董事会制度，后续提案由这些被选中的节点轮流处理。股份授权证明理论上不要求选出的代表个体本身是权益所有人，看起来更民主、更开放。如果选出的代表不作为（轮到自己记账时不记账），或者作恶，可以把他们踢掉，如有必要则进行惩罚（选民们也有可能被惩罚）。股份授权证明机制大大提高了效率，但是减少了记账节点的规模，属于弱中心化。

### 瑞波协议共识算法（Ripple Protocol Consensus Algorithm，RPCA）

瑞波协议共识算法使得一组节点能够基于由特殊信任节点达成共识。在瑞波网络中，每个服务节点都会维护一个信任节点列表且认为信任列表中的节点不会联合起来作弊。在共识过程中，各个需要共识的交易需要接受只接受来自信任节点列表中节点的投票，只有超过一定阈值后才能达成共识。瑞波协议共识算法比较高效，但是同样属于弱中心化且防攻击能力比较弱。

### 实用拜占庭容错算法（Practical Byzantine Fault Tolerance，PBFT）

实用拜占庭容错算法是一种基于消息传递的一致性算法。该算法经过预准备（Pre-prepare）、准备（Prepare）和确认（Commit）三个阶段达成一致性。这些阶段可能因为失败而重复进行。实用拜占庭容错算法信息在节点之间互相交换后，各节点列出所有得到的信息最后以大多数的结果作为解决方法。该算法通过投票达成共识可以很好得解决包括分叉的问题同时提升网络效率, 在保证灵活性和安全性的前提下最大允许 (n-1)/3 故障节点的容错性，但是可扩展性相对较差。

### Paxos

Paxos 算法的基本思想是就是让分布式系统节点按照少数服从多数的方式，最终达成一致意见。Paxos 算法的节点角色分为提议者（Proposer）与决策者（Acceptor），提议者提出提案，提案信息包括提案编号和提议的值，决策者收到提案后可以接受提案，若提案获得多数决策者的接受，则称该提案被批准。提议者先从大多数决策者那里学习提案的最新内容，然后根据学习到的编号最大的提案内容组成新的提案提交，如果提案获得大多数决策者的投票通过就意味着提案被通过。Paxos 算法的性能较高，但是不允许恶意节点存在，所以容错性较差。

### Raft

Raft 算法是对 Paxos 算法的一种简单实现，包括三个角色：领袖（Leader）、群众（Follower）、候选人（Candidate）。Raft 机制可以理解成从全网选出一个记账者，如果它稳定运行没有挂掉，就由这个节点记账，全网无条件接受他的记账结果，相信他是诚实的，假如这个节点挂掉了，那么其他节点是可以通过超时或网络探测感知，然后快速启动一轮投票，来选出一个新的记账节点，然后继续无条件的等它记账，这样就达成了容错性。这在信任度较高的分布式系统中应用是比实用拜占庭容错算法更加高效的一种做法，因为不需要多步的反复确认，受网络影响的可能性也小很多。Raft 算法强调可用性和最终一致性，效率非常高，但是防欺诈性通常只能事后检查。

## 区块链与共识方法

由于共识算法是区块链中的必备因素，所以现有的区块链都采用了相应的共识算法。不同区块链在选择共识算法时，主要需要考虑以下因素：1）可扩展性。网络节点扩展能力的支持程度；2）性能效率。交易达成共识被确认的效率；3）资源消耗。共识过程中耗费的 CPU、网络输入输出、存储等计算机资源；4）容错性。防攻击、防欺诈的能力。

对于私有链，由于是企业内部部署的区块链应用，所有节点都是可以视为信任的且无需代币激励机制，所以通常选择容错性低、性能效率高、无需代币的算法，如 Paxos、Raft 等。联盟链通常是由不同的机构节点组成，网络节点规模可控，内部存在不对等信任的节点且无需激励机制，所以通常选择容算性与性能效率适中、无需代币的算法，如实用拜占庭容错算法等。公有链则是任意节点可以随便加入或者退出，各种故障通常都要考虑，希望所有节点尽量拥有平等的权力并且需要引入代币激励机制，所以通常选择容错性较高、时间效率较低且具有代币激励机制的算法，如工作量证明、权益证明与股份授权证明等。

下表给出了主流的区块链及其采用的共识算法。

| 区块链项目 | 共识算法 |
| ---------- | -------- |
| Bitcoin    | POW      |
| Litecoin   | POW      |
| Ethereum   | POW+POS  |
| Ripple     | RPCA     |
| NXT        | POS      |
| EOS        | DPOS     |
| BitShares  | DPOS     |
| Asch       | DPOS     |
| Zilliqa    | PBFT     |

尽管目前区块链上的共识机制有很多种，但是没有一种共识算法是适用于所有应用场景的。随着区块链应用场景的不断扩展，未来必然不断会有新的区块链共识算法涌现。

# 加密算法

RSA 和椭圆曲线都属于公钥加密算法。

加密传输：发送方用接收方的公钥加密数据，接收方收到密文后用私钥解密。
数字签名：发送方用私钥加密签名，接收方收到签名后用发送方的公钥解密。

椭圆曲线加密中 256 位数的密钥所提供的安全性与 RSA 算法中 3072 位数密钥所提供的安全性相同。椭圆曲线加密相较于 RSA 加密算法，它使用的硬盘空间和带宽不到 RSA 算法的 10%。

## 椭圆曲线加密

公钥：起点 A，终点 E；
私钥：从 A 到 E 的跳数。

从曲线上的某一点开始。我们使用一个 “点函数”（dot function）来发现一个新的点。不断重复 “点函数” 并围绕曲线跳跃（hop），直到我们最终抵达最后一个点上。
点函数可以是过某一点的切线与曲线相交的交点。跳跃是跨 X 轴反射得到的共轭点。

如果你知道哪里是起点（A）以及需要多少跳才能达到终点 E，那么找到终点会很容易。从另一方面来说，如果你知道的只是起点与终点的位置，那么，要发现需要多少跳才能抵达终点几乎是不可能的。

# 分布式一致性算法

3 个基本常识：
（1）信息的传播，需要 “时间”。有 “时间”，就有 “延迟”；有 “延迟”，就有不一致。
（2）信息所反映的 “世界” 一直在变，信息在传播，世界在变化。两者是并行发生的，也就意味着信息的 “过时”。
（3）传递信息的通道，是不可靠的。机器会 crash，网络会断，会有延迟。

在计算机世界，追求绝对的 “一致性”，就好比在物理学中，追求永动机一样。

通常说的 “强一致性”，其实是从观察者的角度得来的！

比如转账，一个账号扣钱、一个账号加钱，必定存在一个短暂的时间窗口：在这个时间窗口内，一个账号的钱减了，但另一个账号的钱，没有加上。只不过这个时间窗口很短，并且对外屏蔽了这个内部的“不一致性”，让客户端看来，是一致的。所以，在这里，客户端看到的是“强一致性”，但从内部来看，你可以认为是“最终一致性”。

分布式系统一般是由多个地位相等的节点组成，一致性问题 (consensus problem) 是分布式系统需要解决的一个核心问题。

## Paxos 算法或其衍生算法

Paxos 类算法仅适用于中心化的分布式系统，各个节点都是可以信任的，它们都严格遵守同样的一套规则。这样的系统的没有不诚实的节点（不会发送虚假错误消息，但允许出现网络不通或宕机出现的消息延迟）。

算法的原理是每个节点可以提出自己的提议，协议的最终目标就是各个节点根据一定的规则达成相同的提议。

我们容易想到的一个规则可能是这样：哪个节点先提出提议，就以谁的为准，后提出的提议无效。但是，分布式系统有网络延迟的问题，导致很难对发生的所有事件进行全局地排序。举个简单的例子，假设节点 A 和 B 分别几乎同时地向节点 X 和 Y 发出了自己的 proposal，但由于消息在网络中的延迟情况不同，最后结果是：X 先收到了 A 的 proposal，后收到了 B 的 proposal；但是 Y 正好相反，它先收到了 B 的 proposal，后收到了 A 的 proposal。这样在 X 和 Y 分别看来，谁先谁后就难以达成一致了。

此外，如果考虑到节点宕机和消息丢失的可能性，情况还会更复杂。实际上，理解问题本身比理解问题的答案要重要的多。

## 拜占庭将军问题

拜占庭将军问题由 Leslie Lamport 提出，也就是 Paxos 的作者。同时，Lamport 还是 2013 年的图灵奖得主。

这个问题大意是这样的：

拜占庭帝国想要进攻一个强大的敌人，为此派出了 10 支军队去包围这个敌人。这个敌人虽不比拜占庭帝国，但也足以抵御 5 支常规拜占庭军队的同时袭击。这 10 支军队在分开的包围状态下同时攻击。他们任一支军队单独进攻都毫无胜算，除非有至少 6 支军队（一半以上）同时袭击才能攻下敌国。他们分散在敌国的四周，依靠通信兵骑马相互通信来协商进攻意向及进攻时间。困扰这些将军的问题是，他们不确定他们中是否有叛徒，叛徒可能擅自变更进攻意向或者进攻时间。在这种状态下，拜占庭将军们如何才能保证有多于 6 支军队在同一时间一起发起进攻，从而赢取战斗？

> 拜占庭将军问题中并不去考虑通信兵是否会被截获或无法传达信息等问题，即消息传递的信道绝无问题。Lamport 已经证明了在消息可能丢失的不可靠信道上试图通过消息传递的方式达到一致性是不可能的。所以，在研究拜占庭将军问题的时候，已经假定了信道是没有问题的.

相关论文：

《The Byzantine Generals Problem》，下载地址：http://lamport.azurewebsites.net/pubs/byz.pdf

《Reaching Agreement in the Presence of Faults》，下载地址：http://lamport.azurewebsites.net/pubs/reaching.pdf

我们这里只提一下论文给出的算法的结论。

使用不同的消息模型，「拜占庭将军问题」有不同的解法。

- 如果将军之间使用口头消息 (oral messages)，也就是说，消息被转述的时候是可能被篡改的，那么要对付 m 个叛徒，需要至少有 3m+1 个将军（其中至少 2m+1 个将军是忠诚的）。

- 如果将军之间使用签名消息 (signed messages)，也就是说，消息被发出来之后是无法伪造的，只要被篡改就会被发现，那么对付 m 个叛徒，只需要至少 m+2 个将军，也就是说至少 2 个忠诚的将军（如果只有 1 个忠诚的将军，显然这个问题没有意义）。这种情况实际相当于对忠诚将军的数目没有限制。

### 共识算法

一个区块链网络是一个完全开放的网络，其中的矿工节点 (miner) 是可以自由加入和自由退出的。这些节点当然有可能是恶意的，所以区块链网络在设计的时候必须要考虑这个问题。这实际上就是典型的「拜占庭将军问题」。

中本聪在比特币中创造性的引入了 “工作量证明（POW : Proof of Work）” 来解决这个问题，通过工作量证明就增加了发送信息的成本，降低节点发送消息速率，这样就以保证在一个时间只有一个节点 (或是很少) 在进行广播，同时在广播时会附上自己的签名。

这个过程就像一位将军 A 在向其他的将军（B、C、D…）发起一个进攻提议一样，将军 B、C、D… 看到将军 A 签过名的进攻提议书，如果是诚实的将军就会立刻同意进攻提议，而不会发起自己新的进攻提议。

以上就是比特币网络中是单个区块（账本）达成共识的方法（取得一致性）。

以上就是比特币网络中是单个区块（账本）达成共识的方法（取得一致性）。

理解了单个区块取得一致性的方法，那么整个区块链（总账本）如果达成一致也好理解。
我们稍微把将军问题改一下：假设攻下一个城堡需要多次的进攻，每次进攻的提议必须基于之前最多次数的胜利进攻下提出的（只有这样敌方已有损失最大，我方进攻胜利的可能性就更大），这样约定之后，将军 A 在收到进攻提议时，就会检查一下这个提议是不是基于最多的胜利提出的，如果不是（基于最多的胜利）将军 A 就不会同意这样的提议，如果是的，将军 A 就会把这次提议记下来。

这就是比特币网络最长链选择。

### 经济学分析

工作量证明其实相当于提高了做叛徒（发布虚假区块）的成本，在工作量证明下，只有第一个完成证明的节点才能广播区块，竞争难度非常大，需要很高的算力，如果不成功其算力就白白的耗费了（算力是需要成本的），如果有这样的算力作为诚实的节点，同样也可以获得很大的收益（这就是矿工所作的工作），这也实际就不会有做叛徒的动机，整个系统也因此而更稳定。

工作量证明会造成巨大的电力浪费，促使人们去探索新的解决一致性（共识）问题的机制：权益证明机制（POS: Proof of Stake）是一个代表。在拜占庭将军问题的角度来看，它同样提高了做叛徒的成本，因为账户需要首先持有大量余额才能有更多的几率广播区块。

区块链到底是什么？有人说是个无法篡改的超级账本，也有人说是个去中心化的交易系统，还有人说它是构建数字货币的底层工具。但是，从技术的角度来说，它首先是个**解决了拜占庭将军问题的分布式网络**，在完全开放的环境中，实现了数据的一致性和安全性。而其它的属性，都附着于这一技术本质之上。
